
      
<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="description" content="Sosyal Hizmet Merkezi - Mobil Görüşme Formu PWA">
  <meta name="keywords" content="sosyal hizmet, görüşme formu, pwa, mobil uygulama">
  <meta name="author" content="Sosyal Hizmet Merkezi">
  
  <!-- PWA Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="SH Formu">
  <meta name="format-detection" content="telephone=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#4a90e2">
  <meta name="msapplication-TileColor" content="#4a90e2">
  <meta name="msapplication-tap-highlight" content="no">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  
  <!-- PWA Icons -->
  <link rel="icon" type="image/png" sizes="32x32" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iOCIgZmlsbD0iIzRhOTBlMiIvPgo8cGF0aCBkPSJNOCAxMkg4LjVIMTBWMTBIOFYxMlpNMTQgMTJIMjRWMTBIMTRWMTJaTTggMThIOC41SDEwVjE2SDhWMThaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMTQgMThIMjRWMTZIMTRWMThaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNOCAyNEg4LjVIMTBWMjJIOFYyNFpNMTQgMjRIMjRWMjJIMTRWMjRaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K">
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiByeD0iNDAiIGZpbGw9IiM0YTkwZTIiLz4KPHN2ZyB4PSI0MCIgeT0iNDAiIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIj4KPHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiPgo8cGF0aCBkPSJNMjAgMzBIMjUuNUgzMFYyMEgyMFYzMFpNNDAgMzBINzBWMjBINDBWMzBaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMjAgNTBIMjUuNUgzMFY0MEgyMFY1MFpNNDAgNTBINzBWNDBINDBWNTBaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMjAgNzBIMjUuNUgzMFY2MEgyMFY3MFpNNDAgNzBINzBWNjBINDBWNzBaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4KPC9zdmc+CjwvZ3N2Zz4K">
  
  <title>Sosyal Hizmet Formu - PWA</title>
  
  <style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, 'Noto Sans', sans-serif;
    background-color: #f8f9fa;
    margin: 0;
    padding: 10px;
    color: #333;
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    -webkit-text-size-adjust: 100%;
    -ms-text-size-adjust: 100%;
    font-size: 16px;
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
  }

  .container {
    max-width: 600px;
    margin: 0 auto;
    background-color: white;
    border-radius: 12px;
    box-shadow: 0 2px 20px rgba(0,0,0,0.1);
    overflow: hidden;
    min-height: calc(100vh - 20px);
  }
  
  .page-header {
    background: linear-gradient(135deg, #4a90e2, #357abd);
    color: white;
    padding: 20px 30px;
    text-align: center;
    position: relative;
  }
  
  .page-header h1 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 5px;
  }
  
  .page-header p {
    margin: 0;
    opacity: 0.9;
    font-size: 0.9rem;
  }
  
  /* PWA Install Banner */
  .pwa-banner {
    background: linear-gradient(135deg, #28a745, #20a745);
    color: white;
    padding: 15px;
    text-align: center;
    display: none;
    position: relative;
    animation: slideDown 0.5s ease;
  }
  
  .pwa-banner.show {
    display: block;
  }
  
  .pwa-banner button {
    background: rgba(255,255,255,0.2);
    border: 1px solid rgba(255,255,255,0.3);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    margin: 0 5px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
  }
  
  .pwa-banner button:hover {
    background: rgba(255,255,255,0.3);
  }
  
  .pwa-banner .close-btn {
    position: absolute;
    top: 10px;
    right: 15px;
    background: none;
    border: none;
    color: white;
    font-size: 20px;
    cursor: pointer;
    padding: 0;
    width: 25px;
    height: 25px;
  }
  
  @keyframes slideDown {
    from { transform: translateY(-100%); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
  
  /* Connection Status */
  .connection-status {
    background: #dc3545;
    color: white;
    padding: 10px;
    text-align: center;
    font-size: 14px;
    display: none;
  }
  
  .connection-status.offline {
    display: block;
    background: #fd7e14;
  }
  
  .connection-status.online {
    display: block;
    background: #28a745;
    animation: fadeOut 3s forwards;
  }
  
  @keyframes fadeOut {
    0% { opacity: 1; }
    70% { opacity: 1; }
    100% { opacity: 0; display: none; }
  }
  
  /* Progress Bar */
  .progress-container {
    background: rgba(255,255,255,0.2);
    height: 4px;
    border-radius: 2px;
    overflow: hidden;
    margin-top: 15px;
  }

  .progress-bar {
    height: 100%;
    background: rgba(255,255,255,0.8);
    width: 0%;
    transition: width 0.3s ease;
    border-radius: 2px;
  }
  
  .form-container {
    padding: 20px;
  }
  
  .form-section {
    margin-bottom: 30px;
    display: none;
    padding: 20px;
    background: white;
    border-radius: 8px;
  }
  
  .form-section.active {
    display: block !important;
    animation: slideIn 0.3s ease;
    background: white;
    padding: 20px;
  }
  
  .form-section.initial-form {
    display: block;
    border-left: none;
    padding-left: 0;
  }
  
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .section-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #4a90e2;
    margin-bottom: 15px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .form-row {
    display: grid;
    grid-template-columns: 1fr;
    gap: 15px;
    margin-bottom: 20px;
  }
  
  .form-group {
    display: flex;
    flex-direction: column;
  }
  
  .form-group.full-width {
    grid-column: 1 / -1;
  }
  
  .form-label {
    font-weight: 500;
    margin-bottom: 8px;
    color: #555;
    font-size: 14px;
  }
  
  .form-control {
    padding: 12px 15px;
    border: 2px solid #e1e8ed;
    border-radius: 8px;
    font-size: 16px;
    font-family: inherit;
    background-color: white;
    transition: all 0.3s ease;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
  }
  
  .form-control:hover {
    border-color: #4a90e2;
  }
  
  .form-control:focus {
    border-color: #4a90e2;
    outline: none;
    box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
  }
  
  .form-control:disabled {
    background-color: #f8f9fa;
    opacity: 0.8;
    cursor: not-allowed;
  }

  .form-control.loading {
    background-image: url("data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Cpath fill='%23007bff' d='M8 0C3.58 0 0 3.58 0 8s3.58 8 8 8c.5 0 .9-.4.9-.9s-.4-.9-.9-.9c-3.32 0-6.1-2.68-6.1-6.1S4.68 1.9 8 1.9s6.1 2.68 6.1 6.1c0 .5.4.9.9.9s.9-.4.9-.9c0-4.42-3.58-8-8-8z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 16px 16px;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
  
  input[type="text"], input[type="number"], input[type="tel"], input[type="email"], input[type="date"] {
    -webkit-appearance: none;
    border-radius: 8px;
  }
  
  select.form-control {
    cursor: pointer;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 16px;
    padding-right: 40px;
  }
  
  textarea.form-control {
    resize: vertical;
    min-height: 100px;
  }
  
  .checkbox-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-height: 300px;
    overflow-y: auto;
    border: 2px solid #e1e8ed;
    border-radius: 8px;
    padding: 15px;
    background-color: #fafafa;
    -webkit-overflow-scrolling: touch;
  }

  .checkbox-item {
    display: flex;
    align-items: center;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.2s;
    -webkit-tap-highlight-color: transparent;
    min-height: 48px;
  }

  .checkbox-item:hover {
    background: #e9ecef;
  }

  .checkbox-item:active {
    background: #dee2e6;
  }

  .checkbox-item input[type="checkbox"] {
    width: auto;
    margin-right: 10px;
    transform: scale(1.2);
    accent-color: #4a90e2;
  }

  .checkbox-item label {
    cursor: pointer;
    margin: 0;
    font-weight: normal;
    line-height: 1.4;
    font-size: 14px;
    flex: 1;
  }

  .checkbox-item.disabled {
    opacity: 0.5;
    pointer-events: none;
  }

  .selection-info {
    background: #e3f2fd;
    padding: 10px;
    border-radius: 6px;
    margin-bottom: 15px;
    font-size: 0.9rem;
    color: #1976d2;
    text-align: center;
  }

  .conditional-field {
    margin-top: 15px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #ffc107;
    display: none;
  }

  .conditional-field.show {
    display: block;
    animation: slideDown 0.3s ease;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .error-message {
    color: #e74c3c;
    font-size: 0.85rem;
    margin-top: 5px;
    padding: 8px;
    background-color: #fdf2f2;
    border-left: 3px solid #e74c3c;
    border-radius: 4px;
    display: none;
  }

  .error-message.show {
    display: block;
  }
  
  .radio-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 10px;
  }
  
  .radio-item {
    display: flex;
    align-items: center;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.2s;
    -webkit-tap-highlight-color: transparent;
    min-height: 48px;
  }

  .radio-item:hover {
    background: #e9ecef;
  }

  .radio-item:active {
    background: #dee2e6;
  }
  
  .radio-item input[type="radio"] {
    width: auto;
    margin-right: 10px;
    transform: scale(1.2);
    accent-color: #4a90e2;
  }
  
  .radio-item label {
    font-size: 14px;
    cursor: pointer;
    margin: 0;
    flex: 1;
  }
  
  .btn {
    padding: 15px 20px;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-family: inherit;
    min-height: 48px;
    -webkit-tap-highlight-color: transparent;
  }
  
  .btn-primary {
    background-color: #4a90e2;
    color: white;
  }
  
  .btn-primary:hover {
    background-color: #357abd;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
  }
  
  .btn-primary:active {
    transform: translateY(0);
  }
  
  .btn-primary:disabled {
    background-color: #c8c8c8;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }
  
  .btn-success {
    background-color: #28a745;
    color: white;
  }
  
  .btn-success:hover {
    background-color: #218838;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
  }
  
  .btn-success:active {
    transform: translateY(0);
  }
  
  .btn-secondary {
    background-color: #6c757d;
    color: white;
  }
  
  .btn-secondary:hover {
    background-color: #545b62;
    transform: translateY(-1px);
  }
  
  .btn-secondary:active {
    transform: translateY(0);
  }
  
  .button-group {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-top: 30px;
    padding-top: 30px;
    border-top: 1px solid #e0e0e0;
    flex-wrap: wrap;
  }
  
  .toast {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    background: #28a745;
    color: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transform: translateX(100%);
    transition: transform 0.3s ease;
    z-index: 1000;
    max-width: 300px;
  }

  .toast.show {
    transform: translateX(0);
  }

  .toast.error {
    background: #dc3545;
  }

  .notification {
    padding: 15px;
    margin: 20px 0;
    border-radius: 4px;
    font-weight: 500;
  }
  
  .notification.success {
    background-color: #dff6dd;
    color: #107c10;
    border: 1px solid #107c10;
  }
  
  .notification.error {
    background-color: #fde7e9;
    color: #d83b01;
    border: 1px solid #d83b01;
  }
  
  .notification.hidden {
    display: none;
  }
  
  .required {
    color: #e74c3c;
    font-weight: bold;
  }
  
  .back-button {
    margin-bottom: 20px;
  }
  
  .form-step {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 4px;
    margin-bottom: 20px;
    text-align: center;
    font-weight: 600;
    color: #4a90e2;
  }
  
  .initial-form {
    display: block;
  }
  
  /* Data Management Section */
  .data-management {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin: 20px 0;
    border-left: 4px solid #4a90e2;
  }
  
  .data-management h3 {
    color: #4a90e2;
    margin-bottom: 15px;
    font-size: 1.1rem;
  }
  
  .data-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 15px;
  }
  
  .data-actions .btn {
    flex: 1;
    min-width: 120px;
    font-size: 0.9rem;
    padding: 10px 15px;
  }
  
  /* Desktop optimizations */
  @media (min-width: 768px) {
    .form-row.two-cols {
      grid-template-columns: 1fr 1fr;
    }
    
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    
    .form-group.half-width {
      flex: 1;
      min-width: calc(50% - 10px);
    }
    
    .form-group.full-width {
      flex: 1 1 100%;
    }
    
    .button-group {
      flex-direction: row;
    }
    
    .btn {
      flex: 1;
      min-width: 120px;
    }
    
    .radio-group {
      flex-direction: row;
      gap: 20px;
      flex-wrap: wrap;
    }
    
    .radio-item {
      flex: 0 0 auto;
      min-width: 120px;
    }
    
    .pwa-banner {
      padding: 10px 20px;
    }
  }
  
  /* Mobile optimizations */
  @media (max-width: 767px) {
    body {
      padding: 5px;
    }
    
    .container {
      margin: 0;
      border-radius: 8px;
      min-height: calc(100vh - 10px);
    }
    
    .page-header {
      padding: 15px 20px;
    }
    
    .page-header h1 {
      font-size: 1.3rem;
    }
    
    .form-container {
      padding: 15px;
    }
    
    .form-row {
      flex-direction: column;
      gap: 15px;
    }
    
    .form-group {
      min-width: auto;
    }
    
    .form-group.half-width {
      min-width: auto;
    }
    
    .button-group {
      flex-direction: column;
    }
    
    .btn {
      width: 100%;
    }
    
    .checkbox-group {
      max-height: 250px;
    }
    
    .toast {
      top: 10px;
      right: 10px;
      left: 10px;
      max-width: none;
      transform: translateY(-100%);
    }

    .toast.show {
      transform: translateY(0);
    }
    
    .data-actions {
      flex-direction: column;
    }
    
    .data-actions .btn {
      width: 100%;
    }
  }
  
  /* High contrast mode support */
  @media (prefers-contrast: high) {
    .form-control {
      border-width: 3px;
    }
    
    .btn {
      border: 2px solid currentColor;
    }
  }
  
  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    * {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }
  
  /* Dark mode support */
  @media (prefers-color-scheme: dark) {
    body {
      background-color: #1a1a1a;
      color: #ffffff;
    }
    
    .container {
      background-color: #2d2d2d;
    }
    
    .form-control {
      background-color: #3d3d3d;
      border-color: #555;
      color: #ffffff;
    }
    
    .form-section {
      background-color: #2d2d2d !important;
    }
    
    .checkbox-item, .radio-item {
      background: #3d3d3d;
    }
    
    .checkbox-item:hover, .radio-item:hover {
      background: #4d4d4d;
    }
  }

  .tooltip {
    position: absolute;
    background: #333;
    color: white;
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 12px;
    z-index: 1000;
    pointer-events: none;
    white-space: nowrap;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  }

  .half-width {
    flex: 1;
    min-width: calc(50% - 10px);
  }

  .full-width {
    flex: 1 1 100%;
  }

  #muhtarlik-form,
  #okul-form,
  #asm-form,
  #hastane-form,
  #hem-form,
  #genclik-form {
    display: none;
  }

  #muhtarlik-form.active,
  #okul-form.active,
  #asm-form.active,
  #hastane-form.active,
  #hem-form.active,
  #genclik-form.active {
    display: block;
  }

  .form-section .section-title {
    background: none;
    color: #4a90e2;
    padding: 10px 0;
    margin: 20px 0 15px 0;
    font-size: 1.1rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: flex;
    align-items: center;
    gap: 8px;
    border: none;
    border-bottom: 2px solid #e1e8ed;
  }

  .form-section > .section-title:first-of-type {
    margin-top: 0;
  }

  #asm-form,
  #okul-form,
  #hastane-form,
  #hem-form,
  #genclik-form {
    padding: 20px;
    background: white;
    border-radius: 12px;
    margin: 0;
  }

  #asm-form.active,
  #okul-form.active,
  #hastane-form.active,
  #hem-form.active,
  #genclik-form.active {
    display: block !important;
    background: white;
  }
  
  /* PWA Specific Styles */
  @media (display-mode: standalone) {
    body {
      padding-top: calc(env(safe-area-inset-top) + 10px);
      user-select: none;
      -webkit-user-select: none;
    }
    
    .page-header {
      padding-top: calc(20px + env(safe-area-inset-top));
    }
  }
  
  /* iOS PWA specific */
  @supports (-webkit-touch-callout: none) {
    .container {
      min-height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 20px);
    }
  }
</style>
</head>

<body>
  <!-- PWA Install Banner -->
  <div id="pwa-banner" class="pwa-banner">
    <button type="button" class="close-btn" onclick="closePWABanner()">&times;</button>
    <div>📱 Bu uygulamayı ana ekranınıza ekleyebilirsiniz!</div>
    <div style="margin-top: 10px;">
      <button onclick="installPWA()">📲 Yükle</button>
      <button onclick="closePWABanner()">❌ Kapat</button>
    </div>
  </div>

  <!-- Connection Status -->
  <div id="connection-status" class="connection-status">
    <span id="connection-text">🔌 İnternet bağlantınız kontrol ediliyor...</span>
  </div>

  <div class="container">
    <!-- Page Header -->
    <div class="page-header">
      <h1>🏛️ Sosyal Hizmet Merkezi</h1>
      <p>Saha Çalışması Görüşme Formları - PWA</p>
      <!-- Progress Bar -->
      <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
      </div>
    </div>

    <div class="form-container">
      <!-- Data Management Section -->
      <div class="data-management">
        <h3>📊 Veri Yönetimi</h3>
        <p>Formlarınızı kaydedin, dışa aktarın veya yedekleyin.</p>
        <div class="data-actions">
          <button type="button" class="btn btn-secondary" onclick="exportAllData()">📤 Tüm Verileri Dışa Aktar</button>
          <button type="button" class="btn btn-secondary" onclick="clearAllData()">🗑️ Tüm Verileri Temizle</button>
          <button type="button" class="btn btn-secondary" onclick="showDataSummary()">📈 Veri Özeti</button>
        </div>
      </div>

      <!-- Initial Form -->
      <div id="initial-form" class="form-section initial-form">
        <div class="section-title">
          📋 Görüşme Bilgilerini Doldurunuz
        </div>
        
        <form id="initialForm">
          <div class="form-row two-cols">
            <div class="form-group">
              <label class="form-label" for="gorusme-tarihi">Görüşme Tarihi <span class="required">*</span></label>
              <input type="date" id="gorusme-tarihi" name="gorusmeTarihi" class="form-control" required>
            </div>
            <div class="form-group">
              <label class="form-label" for="personel-adi">Görüşmeyi Yapan Personelin Adı Soyadı <span class="required">*</span></label>
              <input type="text" id="personel-adi" name="personelAdiSoyadi" class="form-control" required>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="il-secimi">İl Seçimi <span class="required">*</span></label>
            <select id="il-secimi" name="ilSecimi" class="form-control" required>
              <option value="">İl Seçiniz...</option>
            </select>
          </div>

          <div class="form-row two-cols">
            <div class="form-group">
              <label class="form-label" for="ilce-secimi">İlçe Seçimi <span class="required">*</span></label>
              <select id="ilce-secimi" name="ilceSecimi" class="form-control" required disabled>
                <option value="">İlçe seçiniz...</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" for="mahalle-secimi">Mahalle/Belde/Köy Seçimi <span class="required">*</span></label>
              <select id="mahalle-secimi" name="mahalleSecimi" class="form-control" required disabled>
                <option value="">Mahalle/Belde/Köy seçiniz...</option>
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="gorusme-turu">Görüşme Türü <span class="required">*</span></label>
            <select id="gorusme-turu" name="gorusmeTuru" class="form-control" required>
              <option value="">Görüşme türünü seçiniz...</option>
              <option value="muhtarlik">🏛️ Muhtarlık Görüşmesi</option>
              <option value="okul">🏫 Okul Görüşmesi</option>
              <option value="asm">🏥 ASM Görüşmesi</option>
              <option value="hastane">🏥 Hastane Görüşmesi</option>
              <option value="hem">📚 HEM Görüşmesi</option>
              <option value="genclik">👥 Gençlik Merkezi Görüşmesi</option>
            </select>
          </div>
          
          <div class="button-group">
            <button type="button" class="btn btn-primary" onclick="startSelectedForm()" id="start-form-btn">
              ▶️ Forma Başla
            </button>
          </div>
        </form>
      </div>

      <!-- Muhtarlık Formu -->
      <div id="muhtarlik-form" class="form-section">
        <div class="back-button">
          <button type="button" class="btn btn-secondary" onclick="goBackToInitial()">← Geri Dön</button>
        </div>
        
        <form id="muhtarlikGorusmeForm">
          <!-- II. Görüşülen Kişi Bilgileri -->
          <div class="section-title">👤 Görüşülen Kişi Bilgileri</div>
          
          <div class="form-row two-cols">
            <div class="form-group">
              <label class="form-label" for="muhtarlik-muhtar-adi">Muhtarın Adı Soyadı <span class="required">*</span></label>
              <input type="text" id="muhtarlik-muhtar-adi" name="muhtarAdiSoyadi" class="form-control" required>
            </div>
            <div class="form-group">
              <label class="form-label" for="muhtarlik-yas">Muhtarın Yaşı <span class="required">*</span></label>
              <input type="number" id="muhtarlik-yas" name="yas" class="form-control" min="18" max="120" required>
            </div>
          </div>

          <div class="form-row two-cols">
            <div class="form-group">
              <label class="form-label" for="muhtarlik-cinsiyet">Muhtarın Cinsiyeti <span class="required">*</span></label>
              <select id="muhtarlik-cinsiyet" name="cinsiyet" class="form-control" required>
                <option value="">Seçiniz</option>
                <option value="Erkek">Erkek</option>
                <option value="Kadın">Kadın</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" for="muhtarlik-gorev-yili">Muhtarın Görevde Bulunduğu Yıl Sayısı <span class="required">*</span></label>
              <input type="number" id="muhtarlik-gorev-yili" name="gorevYilSayisi" class="form-control" min="0" max="50" required>
            </div>
          </div>

          <div class="form-row two-cols">
            <div class="form-group">
              <label class="form-label" for="muhtarlik-telefon">Muhtarın Telefonu <span class="required">*</span></label>
              <input type="tel" id="muhtarlik-telefon" name="telefon" class="form-control" 
                     pattern="^5[0-9]{9}$" 
                     placeholder="5xxxxxxxxx" 
                     maxlength="10"
                     title="Telefon numarası 5 ile başlamalı ve 10 haneli olmalıdır"
                     required>
            </div>
            <div class="form-group">
              <label class="form-label" for="muhtarlik-eposta">Muhtarın E-Postası</label>
              <input type="email" id="muhtarlik-eposta" name="eposta" class="form-control" placeholder="ornek@email.com">
            </div>
          </div>
                
          <div class="form-group">
            <label class="form-label" for="muhtarlik-gorusme-sayisi">Muhtarlık ile Yapılan Görüşme Sayısı <span class="required">*</span></label>
            <input type="number" id="muhtarlik-gorusme-sayisi" name="gorusmeSayisi" class="form-control" min="1" required>
          </div>

          <!-- III. Mahalle Profili -->
          <div class="section-title">🏘️ Mahalle Profili</div>
          
          <div class="form-row two-cols">
            <div class="form-group">
              <label class="form-label" for="muhtarlik-nufus">Yaklaşık Mahalle Nüfusu <span class="required">*</span></label>
              <input type="number" id="muhtarlik-nufus" name="mahalleNufusu" class="form-control" min="0" required>
            </div>
            <div class="form-group">
              <label class="form-label" for="muhtarlik-hane">Yaklaşık Hane Sayısı <span class="required">*</span></label>
              <input type="number" id="muhtarlik-hane" name="haneSayisi" class="form-control" min="0" required>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Mahallede Öne Çıkan Sosyal Sorunlar <span class="required">*</span></label>
            <div class="selection-info" id="muhtarlik-selection-counter">En fazla 3 sorun seçebilirsiniz. Seçilen: 0/3</div>
            <div class="error-message" id="muhtarlik-sosyal-sorunlar-error">Lütfen en az 1, en fazla 3 sorun seçiniz.</div>
            
            <div class="checkbox-group" id="muhtarlik-sosyal-sorunlar-group">
              <div class="checkbox-item">
                <input type="checkbox" id="muhtarlik-sorun-1" name="sosyalSorunlar" value="Adli Vakaların Sık Yaşanması">
                <label for="muhtarlik-sorun-1">Adli Vakaların Sık Yaşanması (Hırsızlık, Yağma, Yaralama vb.)</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="muhtarlik-sorun-2" name="sosyalSorunlar" value="Aile İçi Şiddet">
                <label for="muhtarlik-sorun-2">Aile İçi Şiddet</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="muhtarlik-sorun-3" name="sosyalSorunlar" value="Bakım Gereksinimi Olan Bireyin Çok Olması">
                <label for="muhtarlik-sorun-3">Bakım Gereksinimi Olan Bireyin Çok Olması</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="muhtarlik-sorun-4" name="sosyalSorunlar" value="Çocuk İşçiliği">
                <label for="muhtarlik-sorun-4">Çocuk İşçiliği</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="muhtarlik-sorun-5" name="sosyalSorunlar" value="İşsizlik">
                <label for="muhtarlik-sorun-5">İşsizlik</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="muhtarlik-sorun-6" name="sosyalSorunlar" value="Madde Satışı">
                <label for="muhtarlik-sorun-6">Madde Satışı</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="muhtarlik-sorun-7" name="sosyalSorunlar" value="Maddenin Kötüye Kullanımı">
                <label for="muhtarlik-sorun-7">Maddenin Kötüye Kullanımı</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="muhtarlik-sorun-8" name="sosyalSorunlar" value="Maddi Yetersizlik">
                <label for="muhtarlik-sorun-8">Maddi Yetersizlik / Temel İhtiyaçları Karşılayamama</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="muhtarlik-sorun-9" name="sosyalSorunlar" value="Mülteci/Göçmen Yoğunluğu">
                <label for="muhtarlik-sorun-9">Mülteci/Göçmen Yoğunluğu</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="muhtarlik-sorun-10" name="sosyalSorunlar" value="Okula Devamsızlık">
                <label for="muhtarlik-sorun-10">Okula Devamsızlık</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="muhtarlik-sorun-diger" name="sosyalSorunlar" value="Diğer">
                <label for="muhtarlik-sorun-diger">Diğer</label>
              </div>
            </div>
           
            <div class="conditional-field" id="muhtarlik-other-input">
              <label class="form-label" for="muhtarlik-diger-sorun-detay">Lütfen diğer sosyal sorunu belirtiniz <span class="required">*</span></label>
              <textarea id="muhtarlik-diger-sorun-detay" name="digerSorunDetay" class="form-control" rows="3" placeholder="Diğer sosyal sorunu buraya yazınız..."></textarea>
              <div class="error-message" id="muhtarlik-other-error">Bu alan zorunludur.</div>
            </div>
          </div>

          <!-- IV. Sosyal Hizmete Yaklaşım -->
          <div class="section-title">🤝 Sosyal Hizmete Yaklaşım</div>
          
          <div class="form-group">
            <label class="form-label">Sosyal Hizmet Merkezinde yürütülen çalışmalar hakkında bilginiz var mı? <span class="required">*</span></label>
            <div class="radio-group">
              <div class="radio-item">
                <input type="radio" id="muhtarlik-bilgi-evet" name="shBilgisi" value="Evet" required>
                <label for="muhtarlik-bilgi-evet">Evet</label>
              </div>
              <div class="radio-item">
                <input type="radio" id="muhtarlik-bilgi-hayir" name="shBilgisi" value="Hayır" required>
                <label for="muhtarlik-bilgi-hayir">Hayır</label>
              </div>
            </div>
            <div class="conditional-field" id="muhtarlik-sh-bilgi-detay">
              <label class="form-label" for="muhtarlik-hangi-hizmetler">Hangi hizmetler hakkında bilginiz var? <span class="required">*</span></label>
              <textarea id="muhtarlik-hangi-hizmetler" name="hangiHizmetler" class="form-control" rows="3"></textarea>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Sosyal Hizmet Merkeziyle daha önce hiç iletişime geçtiniz mi? <span class="required">*</span></label>
            <div class="radio-group">
              <div class="radio-item">
                <input type="radio" id="muhtarlik-iletisim-evet" name="shIletisim" value="Evet" required>
                <label for="muhtarlik-iletisim-evet">Evet</label>
              </div>
              <div class="radio-item">
                <input type="radio" id="muhtarlik-iletisim-hayir" name="shIletisim" value="Hayır" required>
                <label for="muhtarlik-iletisim-hayir">Hayır</label>
              </div>
            </div>
            <div class="conditional-field" id="muhtarlik-sh-iletisim-detay">
              <label class="form-label" for="muhtarlik-iletisim-konu">Hangi konuda iletişime geçtiniz? <span class="required">*</span></label>
              <textarea id="muhtarlik-iletisim-konu" name="iletisimKonusu" class="form-control" rows="3"></textarea>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Mahalle sakinleri size sosyal yardım/sosyal hizmet talebiyle başvuruyor mu? <span class="required">*</span></label>
            <div class="radio-group">
              <div class="radio-item">
                <input type="radio" id="muhtarlik-basvuru-evet" name="sakinBasvuru" value="Evet" required>
                <label for="muhtarlik-basvuru-evet">Evet</label>
              </div>
              <div class="radio-item">
                <input type="radio" id="muhtarlik-basvuru-hayir" name="sakinBasvuru" value="Hayır" required>
                <label for="muhtarlik-basvuru-hayir">Hayır</label>
              </div>
            </div>
            <div class="conditional-field" id="muhtarlik-sakin-basvuru-detay">
              <label class="form-label" for="muhtarlik-basvuru-konular">En sık gelen başvuru konuları nelerdir? <span class="required">*</span></label>
              <textarea id="muhtarlik-basvuru-konular" name="basvuruKonulari" class="form-control" rows="3"></textarea>
            </div>
          </div>

          <!-- V. Bilgilendirme / İş Birliği -->
          <div class="section-title">🤝 Bilgilendirme / İş Birliği</div>
          
          <div class="form-group">
            <label class="form-label">Ortak çalışma istenir mi? <span class="required">*</span></label>
            <div class="radio-group">
              <div class="radio-item">
                <input type="radio" id="muhtarlik-ortakcalisma-evet" name="ortakCalisma" value="Evet" required>
                <label for="muhtarlik-ortakcalisma-evet">Evet</label>
              </div>
              <div class="radio-item">
                <input type="radio" id="muhtarlik-ortakcalisma-hayir" name="ortakCalisma" value="Hayır" required>
                <label for="muhtarlik-ortakcalisma-hayir">Hayır</label>
              </div>
            </div>
            <div class="conditional-field" id="muhtarlik-ortak-calisma-detay">
              <label class="form-label" for="muhtarlik-tercih-konular">Tercih edilen konular <span class="required">*</span></label>
              <textarea id="muhtarlik-tercih-konular" name="tercihKonular" class="form-control" rows="3"></textarea>
            </div>
          </div>

          <!-- VI. Gözlem ve Değerlendirme -->
          <div class="section-title">👁️ Gözlem ve Değerlendirme</div>
          
          <div class="form-group">
            <label class="form-label">Görüşülen kişinin iş birliği yaklaşımı <span class="required">*</span></label>
            <div class="radio-group">
              <div class="radio-item">
                <input type="radio" id="muhtarlik-isbirligi-istekli" name="isBirligiYaklasimi" value="İstekli" required>
                <label for="muhtarlik-isbirligi-istekli">İstekli</label>
              </div>
              <div class="radio-item">
                <input type="radio" id="muhtarlik-isbirligi-kararsiz" name="isBirligiYaklasimi" value="Kararsız" required>
                <label for="muhtarlik-isbirligi-kararsiz">Kararsız</label>
              </div>
              <div class="radio-item">
                <input type="radio" id="muhtarlik-isbirligi-isteksiz" name="isBirligiYaklasimi" value="İsteksiz" required>
                <label for="muhtarlik-isbirligi-isteksiz">İsteksiz</label>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="muhtarlik-dikkat-hususlar">Görüşme sırasında dikkat çeken hususlar <span class="required">*</span></label>
            <textarea id="muhtarlik-dikkat-hususlar" name="dikkatHususlar" class="form-control" rows="4" required></textarea>
          </div>

          <div class="button-group">
            <button type="button" class="btn btn-success" onclick="kaydetForm('muhtarlik')">💾 Kaydet</button>
            <button type="reset" class="btn btn-primary" onclick="temizleForm()">🔄 Temizle</button>
          </div>
        </form>
      </div>

      <!-- Notification Area -->
      <div id="notification" class="notification hidden"></div>
    </div>
  </div>

  <script> 

  // PWA Global Variables
let deferredPrompt = null;
let isOnline = navigator.onLine;
let swRegistration = null;

// Global variables
let selectedFormType = null;
let initialFormData = {};
let formChanged = false;

// İl-İlçe-Mahalle verileri (genişletilmiş veriler)
const locationData = { 
  "adana": {
    "name": "ADANA",
    "districts": {
      "aladağ": {
        "name": "ALADAĞ",
        "neighborhoods": [
          "BOZTAHTA", "BÜYÜKSOFULU", "CERİTLER", "DARILIK", "DAYILAR", "DÖLEKLİ", 
          "EĞNER", "GERDİBİ", "GÖKÇE", "EBRİŞİM", "KABASAKAL", "KARAHAN", 
          "KICAK", "KIŞLAK", "KIZILDAM", "KÖKEZ", "KÖPRÜCÜK", "KÜP", "MADENLİ", 
          "MAZILIK", "TOPALLI", "UZUNKUYU", "POSYAĞBASAN", "GİREĞİYENİKÖY", 
          "YETİMLİ", "YÜKSEKÖREN", "AKÖREN", "SİNANPAŞA", "BAŞPINAR", "AKPINAR", "MANSURLU"
        ]
      },
      "ceyhan": {
        "name": "CEYHAN",
        "neighborhoods": [
          "MERKEZ", "KADIRLI", "BAHÇE", "DÜZIÇI", "HAMAMLI", "KURTKULAĞI",
          "KÜRKÇÜLER", "SOFULAR", "TAPANLI", "YENİŞEHİR"
        ]
      }
    }
  },
  "ankara": {
    "name": "ANKARA",
    "districts": {
      "çankaya": {
        "name": "ÇANKAYA",
        "neighborhoods": [
          "KIZILIRMAK", "ÇANKAYA", "YENİMAHALLE", "BALGAT", "ÇAYYOLU",
          "UMİTKÖY", "İLKBAHAR", "KONUTKENT", "MESA", "ORAN"
        ]
      },
      "keçiören": {
        "name": "KEÇİÖREN",
        "neighborhoods": [
          "AKTEPE", "BAĞLARBAŞI", "ESERTEPE", "ETLIK", "IŞINLAR",
          "KALABA", "KAMIL OCAK", "KARŞIYAKA", "KUŞCAĞIZ", "PIYANGOTEPE"
        ]
      }
    }
  }
};

// DOM yüklendiğinde çalışacak ana fonksiyon
document.addEventListener('DOMContentLoaded', function() {
  console.log('🔄 PWA Form yüklendi, başlatılıyor...');
  initializePWA();
});

// PWA başlatma fonksiyonu
async function initializePWA() {
  try {
    console.log('🚀 PWA başlatılıyor...');
    
    // Service Worker kaydı
    await registerServiceWorker();
    
    // PWA event listener'ları
    setupPWAEventListeners();
    
    // Connection status monitoring
    setupConnectionMonitoring();
    
    // Form başlatma
    initializeForm();
    
    // PWA install prompt
    setupInstallPrompt();
    
    console.log('✅ PWA başarıyla yüklendi!');
  } catch (error) {
    console.error('❌ PWA başlatma hatası:', error);
    reportError(error, 'PWA initialization');
  }
}

// Service Worker kaydı
async function registerServiceWorker() {
  if ('serviceWorker' in navigator) {
    try {
      const registration = await navigator.serviceWorker.register('/sw.js', {
        scope: '/'
      });
      
      swRegistration = registration;
      console.log('✅ Service Worker kayıtlı:', registration.scope);
      
      // Service Worker güncellemelerini dinle
      registration.addEventListener('updatefound', () => {
        console.log('🔄 Service Worker güncellemesi bulundu');
        const newWorker = registration.installing;
        
        newWorker.addEventListener('statechange', () => {
          if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
            showUpdateAvailable();
          }
        });
      });
      
      // Service Worker mesajlarını dinle
      navigator.serviceWorker.addEventListener('message', handleSWMessage);
      
    } catch (error) {
      console.error('❌ Service Worker kayıt hatası:', error);
    }
  } else {
    console.warn('⚠️ Service Worker desteklenmiyor');
  }
}

// Service Worker mesajlarını işle
function handleSWMessage(event) {
  const { type, payload } = event.data;
  
  switch (type) {
    case 'FORM_SYNCED':
      showToast('Form başarıyla senkronize edildi! 🔄', 'success');
      break;
      
    case 'SYNC_FAILED':
      showToast('Form senkronizasyonu başarısız oldu. ❌', 'error');
      break;
      
    default:
      console.log('Service Worker mesajı:', event.data);
  }
}

// PWA install prompt kurulumu
function setupInstallPrompt() {
  window.addEventListener('beforeinstallprompt', (e) => {
    console.log('📱 PWA install prompt hazır');
    e.preventDefault();
    deferredPrompt = e;
    showPWABanner();
  });
  
  window.addEventListener('appinstalled', () => {
    console.log('🎉 PWA yüklendi!');
    hidePWABanner();
    showToast('Uygulama başarıyla yüklendi! 🎉', 'success');
    deferredPrompt = null;
  });
}

// PWA banner göster
function showPWABanner() {
  const banner = document.getElementById('pwa-banner');
  if (banner && deferredPrompt) {
    banner.classList.add('show');
  }
}

// PWA banner gizle
function hidePWABanner() {
  const banner = document.getElementById('pwa-banner');
  if (banner) {
    banner.classList.remove('show');
  }
}

// PWA banner kapat
function closePWABanner() {
  hidePWABanner();
  deferredPrompt = null;
}

// PWA yükle
async function installPWA() {
  if (!deferredPrompt) {
    showToast('Yükleme şu anda mevcut değil.', 'error');
    return;
  }
  
  try {
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    
    console.log('👤 Kullanıcı seçimi:', outcome);
    
    if (outcome === 'accepted') {
      showToast('Uygulama yükleniyor... ⏳', 'success');
    } else {
      showToast('Yükleme iptal edildi.', 'error');
    }
    
    deferredPrompt = null;
    hidePWABanner();
  } catch (error) {
    console.error('❌ PWA yükleme hatası:', error);
    showToast('Yükleme sırasında hata oluştu.', 'error');
  }
}

// Bağlantı durumu izleme
function setupConnectionMonitoring() {
  const connectionStatus = document.getElementById('connection-status');
  const connectionText = document.getElementById('connection-text');
  
  function updateConnectionStatus() {
    const online = navigator.onLine;
    
    if (online !== isOnline) {
      isOnline = online;
      
      if (online) {
        connectionStatus.className = 'connection-status online';
        connectionText.textContent = '🌐 İnternet bağlantısı yeniden kuruldu!';
        
        // Auto-hide after 3 seconds
        setTimeout(() => {
          connectionStatus.style.display = 'none';
        }, 3000);
        
        // Trigger background sync
        triggerBackgroundSync();
        
      } else {
        connectionStatus.className = 'connection-status offline';
        connectionText.textContent = '📴 İnternet bağlantısı yok - Çevrimdışı modda çalışıyor';
      }
    }
  }
  
  window.addEventListener('online', updateConnectionStatus);
  window.addEventListener('offline', updateConnectionStatus);
  
  // Initial check
  updateConnectionStatus();
}

// Background sync tetikle
async function triggerBackgroundSync() {
  if ('serviceWorker' in navigator && 'sync' in window.ServiceWorkerRegistration.prototype) {
    try {
      const registration = await navigator.serviceWorker.ready;
      await registration.sync.register('form-submission');
      console.log('🔄 Background sync tetiklendi');
    } catch (error) {
      console.error('❌ Background sync hatası:', error);
    }
  }
}

// PWA event listener'ları kur
function setupPWAEventListeners() {
  // Visibility change - battery optimization
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      console.log('📱 Uygulama arka plana geçti');
      autoSave();
    } else {
      console.log('📱 Uygulama ön plana geçti');
      updateProgress();
    }
  });
  
  // Page unload - save state
  window.addEventListener('beforeunload', (e) => {
    if (formChanged) {
      autoSave();
      e.preventDefault();
      e.returnValue = 'Formda değişiklikler var. Sayfadan ayrılmak istediğinizden emin misiniz?';
    }
  });
  
  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    // Ctrl/Cmd + S = Save
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
      e.preventDefault();
      if (selectedFormType) {
        kaydetForm(selectedFormType);
      }
    }
    
    // Ctrl/Cmd + N = New form
    if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
      e.preventDefault();
      if (confirm('Yeni form başlatmak istiyor musunuz?')) {
        goBackToInitial();
        temizleForm();
      }
    }
  });
}

// Service Worker güncellemesi mevcut
function showUpdateAvailable() {
  const updateBanner = document.createElement('div');
  updateBanner.className = 'pwa-banner show';
  updateBanner.innerHTML = `
    <button type="button" class="close-btn" onclick="this.parentElement.remove()">&times;</button>
    <div>🔄 Yeni sürüm mevcut!</div>
    <div style="margin-top: 10px;">
      <button onclick="updateServiceWorker()">🚀 Güncelle</button>
      <button onclick="this.parentElement.remove()">❌ Daha Sonra</button>
    </div>
  `;
  
  document.body.insertBefore(updateBanner, document.body.firstChild);
}

// Service Worker güncelle
async function updateServiceWorker() {
  if (swRegistration && swRegistration.waiting) {
    swRegistration.waiting.postMessage({ type: 'SKIP_WAITING' });
    
    navigator.serviceWorker.addEventListener('controllerchange', () => {
      window.location.reload();
    });
  }
}

// Veri yönetimi fonksiyonları
async function exportAllData() {
  try {
    showToast('Veriler dışa aktarılıyor... ⏳', 'success');
    
    const data = {
      version: '2.0.0',
      exportDate: new Date().toISOString(),
      forms: await getAllStoredForms(),
      settings: getAppSettings(),
      metadata: {
        deviceInfo: {
          userAgent: navigator.userAgent,
          platform: navigator.platform,
          language: navigator.language
        }
      }
    };
    
    const fileName = `sh-formlar-yedek-${new Date().toISOString().split('T')[0]}.json`;
    downloadAsJSON(data, fileName.replace('.json', ''));
    
    showToast('Tüm veriler başarıyla dışa aktarıldı! 📤', 'success');
  } catch (error) {
    console.error('❌ Veri dışa aktarma hatası:', error);
    showToast('Veri dışa aktarma sırasında hata oluştu.', 'error');
  }
}

async function clearAllData() {
  if (!confirm('TÜM VERİLER SİLİNECEK!\n\nBu işlem geri alınamaz. Devam etmek istediğinizden emin misiniz?')) {
    return;
  }
  
  if (!confirm('Son uyarı: Tüm form verileri, ayarlar ve önbellek silinecek. Emin misiniz?')) {
    return;
  }
  
  try {
    showToast('Tüm veriler temizleniyor... ⏳', 'success');
    
    // Clear localStorage
    localStorage.clear();
    
    // Clear IndexedDB
    await clearIndexedDB();
    
    // Clear caches through Service Worker
    if (swRegistration) {
      const messageChannel = new MessageChannel();
      swRegistration.active.postMessage(
        { type: 'CLEAR_CACHE' },
        [messageChannel.port2]
      );
      
      await new Promise((resolve) => {
        messageChannel.port1.onmessage = resolve;
      });
    }
    
    showToast('Tüm veriler başarıyla temizlendi! 🗑️', 'success');
    
    // Reload page
    setTimeout(() => {
      window.location.reload();
    }, 2000);
    
  } catch (error) {
    console.error('❌ Veri temizleme hatası:', error);
    showToast('Veri temizleme sırasında hata oluştu.', 'error');
  }
}

async function showDataSummary() {
  try {
    const forms = await getAllStoredForms();
    const cacheInfo = await getCacheInfo();
    
    const summary = {
      totalForms: forms.length,
      formsByType: {},
      oldestForm: null,
      newestForm: null,
      cacheSize: cacheInfo.totalCaches || 0
    };
    
    forms.forEach(form => {
      const type = form.formTuru || 'bilinmeyen';
      summary.formsByType[type] = (summary.formsByType[type] || 0) + 1;
      
      const date = new Date(form.tarih);
      if (!summary.oldestForm || date < new Date(summary.oldestForm)) {
        summary.oldestForm = form.tarih;
      }
      if (!summary.newestForm || date > new Date(summary.newestForm)) {
        summary.newestForm = form.tarih;
      }
    });
    
    const summaryText = `
📊 VERİ ÖZETİ

📋 Toplam Form: ${summary.totalForms}

📑 Form Türlerine Göre Dağılım:
${Object.entries(summary.formsByType).map(([type, count]) => `  • ${getFormDisplayName(type)}: ${count}`).join('\n')}

📅 En Eski Form: ${summary.oldestForm ? new Date(summary.oldestForm).toLocaleDateString('tr-TR') : 'Yok'}
📅 En Yeni Form: ${summary.newestForm ? new Date(summary.newestForm).toLocaleDateString('tr-TR') : 'Yok'}

💾 Önbellek Boyutu: ${summary.cacheSize} önbellek
    `.trim();
    
    alert(summaryText);
    
  } catch (error) {
    console.error('❌ Veri özeti hatası:', error);
    showToast('Veri özeti alınırken hata oluştu.', 'error');
  }
}

// IndexedDB helper fonksiyonları
async function getAllStoredForms() {
  try {
    return JSON.parse(localStorage.getItem('all_forms') || '[]');
  } catch (error) {
    console.error('❌ Form verilerini alma hatası:', error);
    return [];
  }
}

async function clearIndexedDB() {
  return new Promise((resolve, reject) => {
    const deleteReq = indexedDB.deleteDatabase('SHFormDB');
    deleteReq.onsuccess = () => resolve();
    deleteReq.onerror = () => reject(deleteReq.error);
  });
}

async function getCacheInfo() {
  if (!swRegistration) return { totalCaches: 0 };
  
  try {
    const messageChannel = new MessageChannel();
    swRegistration.active.postMessage(
      { type: 'GET_CACHE_INFO' },
      [messageChannel.port2]
    );
    
    return new Promise((resolve) => {
      messageChannel.port1.onmessage = (event) => {
        resolve(event.data);
      };
    });
  } catch (error) {
    console.error('❌ Cache bilgisi alma hatası:', error);
    return { totalCaches: 0 };
  }
}

function getAppSettings() {
  return {
    language: localStorage.getItem('app_language') || 'tr',
    theme: localStorage.getItem('app_theme') || 'light',
    autoSave: localStorage.getItem('auto_save') !== 'false'
  };
}

// Form başlatma fonksiyonu
function initializeForm() {
  try {
    console.log('📋 Form başlatma işlemi başladı...');
    
    // İlleri doldur
    fillIllers();
    
    // Event listener'ları kur
    setupLocationEventListeners();
    setupFormEventListeners();
    
    // Diğer başlatma işlemleri
    setupProgressTracking();
    setupCheckboxLimits();
    setupConditionalFields();
    setupFormValidation();
    setupMobileOptimizations();
    setDefaultDate();
    
    console.log('✅ Form başarıyla yüklendi!');
  } catch (error) {
    console.error('❌ Form başlatma hatası:', error);
    reportError(error, 'Form initialization');
  }
}

// İlleri dropdown'a doldur
function fillIllers() {
  console.log('🏙️ İller dolduruluyor...');
  
  const ilSelect = document.getElementById('il-secimi');
  if (!ilSelect) {
    console.warn('⚠️ il-secimi elementi bulunamadı!');
    return;
  }
  
  // Önce temizle
  ilSelect.innerHTML = '<option value="">İl Seçiniz...</option>';
  
  // locationData kontrolü
  if (!locationData || typeof locationData !== 'object') {
    console.error('❌ locationData tanımlı değil veya geçersiz!');
    return;
  }
  
  try {
    // İlleri ekle
    Object.keys(locationData).forEach(ilKey => {
      const ilData = locationData[ilKey];
      if (ilData && ilData.name) {
        const option = document.createElement('option');
        option.value = ilKey;
        option.textContent = ilData.name;
        ilSelect.appendChild(option);
      }
    });
    
    console.log(`✅ ${Object.keys(locationData).length} il başarıyla yüklendi`);
  } catch (error) {
    console.error('❌ İller yüklenirken hata:', error);
  }
}

// Location event listener'larını kur
function setupLocationEventListeners() {
  console.log('🔗 Location event listenerları kuruluyor...');
  
  const ilSelect = document.getElementById('il-secimi');
  const ilceSelect = document.getElementById('ilce-secimi');
  
  if (ilSelect) {
    ilSelect.removeEventListener('change', handleIlChange);
    ilSelect.addEventListener('change', handleIlChange);
    console.log('✅ İl change event listener eklendi');
  }
  
  if (ilceSelect) {
    ilceSelect.removeEventListener('change', handleIlceChange);
    ilceSelect.addEventListener('change', handleIlceChange);
    console.log('✅ İlçe change event listener eklendi');
  }
}

// İl değişikliği handler
function handleIlChange(event) {
  console.log('🏙️ İl değişti:', event.target.value);
  updateIlceler();
  updateProgress();
}

// İlçe değişikliği handler
function handleIlceChange(event) {
  console.log('🏘️ İlçe değişti:', event.target.value);
  updateMahalleler();
  updateProgress();
}

// İlçeleri güncelle
function updateIlceler() {
  console.log('🔄 İlçeler güncelleniyor...');
  
  const ilSelect = document.getElementById('il-secimi');
  const ilceSelect = document.getElementById('ilce-secimi');
  const mahalleSelect = document.getElementById('mahalle-secimi');
  
  if (!ilSelect || !ilceSelect || !mahalleSelect) {
    console.warn('⚠️ Gerekli select elementleri bulunamadı');
    return;
  }
  
  const selectedIl = ilSelect.value;
  console.log('🏙️ Seçilen il:', selectedIl);
  
  // İlçe ve mahalle dropdownlarını sıfırla
  ilceSelect.innerHTML = '<option value="">İlçe seçiniz...</option>';
  mahalleSelect.innerHTML = '<option value="">Önce ilçe seçiniz...</option>';
  mahalleSelect.disabled = true;
  
  if (!selectedIl) {
    ilceSelect.disabled = true;
    console.log('ℹ️ İl seçimi boş, ilçe dropdown devre dışı');
    return;
  }
  
  // İl verilerini kontrol et
  if (!locationData[selectedIl] || !locationData[selectedIl].districts) {
    console.error('❌ Seçilen il için veri bulunamadı:', selectedIl);
    ilceSelect.disabled = true;
    return;
  }
  
  try {
    const districts = locationData[selectedIl].districts;
    ilceSelect.disabled = false;
    
    // İlçeleri ekle
    Object.keys(districts).forEach(districtKey => {
      const district = districts[districtKey];
      if (district && district.name) {
        const option = document.createElement('option');
        option.value = districtKey;
        option.textContent = district.name;
        ilceSelect.appendChild(option);
      }
    });
    
    console.log(`✅ ${Object.keys(districts).length} ilçe yüklendi`);
    
    // Smooth animation
    ilceSelect.style.opacity = '0.5';
    setTimeout(() => {
      ilceSelect.style.opacity = '1';
    }, 150);
    
  } catch (error) {
    console.error('❌ İlçeler yüklenirken hata:', error);
    ilceSelect.disabled = true;
  }
}

// Mahalleleri güncelle
function updateMahalleler() {
  console.log('🔄 Mahalleler güncelleniyor...');
  
  const ilSelect = document.getElementById('il-secimi');
  const ilceSelect = document.getElementById('ilce-secimi');
  const mahalleSelect = document.getElementById('mahalle-secimi');
  
  if (!ilSelect || !ilceSelect || !mahalleSelect) {
    console.warn('⚠️ Gerekli select elementleri bulunamadı');
    return;
  }
  
  const selectedIl = ilSelect.value;
  const selectedIlce = ilceSelect.value;
  
  console.log('🏙️ Seçilen il:', selectedIl, 'İlçe:', selectedIlce);
  
  // Mahalle dropdownını sıfırla
  mahalleSelect.innerHTML = '<option value="">Mahalle/Belde/Köy seçiniz...</option>';
  
  if (!selectedIl || !selectedIlce) {
    mahalleSelect.disabled = true;
    console.log('ℹ️ İl veya ilçe seçimi boş, mahalle dropdown devre dışı');
    return;
  }
  
  // Veri kontrolü
  if (!locationData[selectedIl] || 
      !locationData[selectedIl].districts || 
      !locationData[selectedIl].districts[selectedIlce] || 
      !locationData[selectedIl].districts[selectedIlce].neighborhoods) {
    console.error('❌ Seçilen il/ilçe için mahalle verisi bulunamadı');
    mahalleSelect.disabled = true;
    return;
  }
  
  try {
    const neighborhoods = locationData[selectedIl].districts[selectedIlce].neighborhoods;
    mahalleSelect.disabled = false;
    
    // Mahalleleri ekle
    neighborhoods.forEach(neighborhood => {
      const option = document.createElement('option');
      option.value = neighborhood;
      option.textContent = neighborhood;
      mahalleSelect.appendChild(option);
    });
    
    console.log(`✅ ${neighborhoods.length} mahalle yüklendi`);
    
    // Smooth animation
    mahalleSelect.style.opacity = '0.5';
    setTimeout(() => {
      mahalleSelect.style.opacity = '1';
    }, 150);
    
  } catch (error) {
    console.error('❌ Mahalleler yüklenirken hata:', error);
    mahalleSelect.disabled = true;
  }
}

// Form event listener'larını kur
function setupFormEventListeners() {
  console.log('📝 Form event listenerları kuruluyor...');
  
  // Form değişiklik takibi
  document.addEventListener('change', function(e) {
    formChanged = true;
    updateProgress();
  });

  document.addEventListener('input', function(e) {
    formChanged = true;
    updateProgress();
  });

  // Sayfa çıkış uyarısı
  window.addEventListener('beforeunload', function(e) {
    if (formChanged) {
      e.preventDefault();
      e.returnValue = 'Formda değişiklikler var. Sayfadan ayrılmak istediğinizden emin misiniz?';
    }
  });

  // Keyboard navigation
  document.addEventListener('keydown', handleKeyboardNavigation);
  
  console.log('✅ Form event listenerları kuruldu');
}

// Progress tracking kurulumu
function setupProgressTracking() {
  const progressBar = document.getElementById('progressBar');
  if (progressBar) {
    updateProgress();
    console.log('✅ Progress tracking kuruldu');
  }
}

// Progress güncelleme
function updateProgress() {
  const activeForm = document.querySelector('.form-section.active') || 
                    document.querySelector('.initial-form') ||
                    document.getElementById('initialForm');
  
  if (!activeForm) return;
  
  const inputs = activeForm.querySelectorAll('input[required], select[required], textarea[required]');
  let filled = 0;
  let total = inputs.length;
  
  const processedRadioGroups = new Set();
  const processedCheckboxGroups = new Set();
  
  inputs.forEach(input => {
    if (input.type === 'radio') {
      if (!processedRadioGroups.has(input.name)) {
        processedRadioGroups.add(input.name);
        const checkedRadio = activeForm.querySelector(`input[name="${input.name}"]:checked`);
        if (checkedRadio) {
          filled++;
        }
      }
    } else if (input.type === 'checkbox') {
      if (!processedCheckboxGroups.has(input.name)) {
        processedCheckboxGroups.add(input.name);
        const checkedBoxes = activeForm.querySelectorAll(`input[name="${input.name}"]:checked`);
        if (checkedBoxes.length > 0) {
          filled++;
        }
      }
    } else if (input.value && input.value.trim() !== '') {
      filled++;
    }
  });
  
  // Radio ve checkbox gruplarının sayısını düzelt
  total = inputs.length - (inputs.length - processedRadioGroups.size - processedCheckboxGroups.size - 
          Array.from(inputs).filter(input => input.type !== 'radio' && input.type !== 'checkbox').length) +
          processedRadioGroups.size + processedCheckboxGroups.size +
          Array.from(inputs).filter(input => input.type !== 'radio' && input.type !== 'checkbox').length;
  
  const percentage = total > 0 ? (filled / total) * 100 : 0;
  const progressBar = document.getElementById('progressBar');
  
  if (progressBar) {
    progressBar.style.width = percentage + '%';
    
    // Progress bar renk değişimi
    if (percentage < 30) {
      progressBar.style.background = '#f44336';
    } else if (percentage < 70) {
      progressBar.style.background = '#ff9800';
    } else {
      progressBar.style.background = '#4caf50';
    }
  }
}

// Seçilen forma başla
function startSelectedForm() {
  const form = document.getElementById('initialForm');
  
  // Form validasyonu
  if (!validateInitialForm()) {
    return;
  }

  // İlk form verilerini kaydet
  const formData = new FormData(form);
  initialFormData = {};
  for (let [key, value] of formData.entries()) {
    initialFormData[key] = value;
  }

  selectedFormType = document.getElementById('gorusme-turu').value;
  
  if (!selectedFormType) {
    showToast('Lütfen görüşme türünü seçiniz.', 'error');
    return;
  }

  // Smooth transition
  const initialForm = document.getElementById('initial-form');
  const targetForm = document.getElementById(`${selectedFormType}-form`);
  
  if (!initialForm || !targetForm) {
    console.error('❌ Form elementleri bulunamadı');
    return;
  }
  
  initialForm.style.opacity = '0';
  setTimeout(() => {
    initialForm.style.display = 'none';
    targetForm.classList.add('active');
    targetForm.style.display = 'block';
    targetForm.style.background = 'white';
    targetForm.style.padding = '20px';
    targetForm.style.opacity = '0';
    
    setTimeout(() => {
      targetForm.style.opacity = '1';
      updateProgress();
    }, 50);
  }, 300);
  
  showToast(`${getFormDisplayName(selectedFormType)} formu başlatıldı!`, 'success');
}

// Form görünen adını al
function getFormDisplayName(formType) {
  const formNames = {
    'muhtarlik': 'Muhtarlık',
    'okul': 'Okul',
    'asm': 'ASM',
    'hastane': 'Hastane',
    'hem': 'HEM',
    'genclik': 'Gençlik Merkezi'
  };
  return formNames[formType] || formType.toUpperCase();
}

// İlk form validasyonu
function validateInitialForm() {
  const requiredFields = document.querySelectorAll('#initialForm input[required], #initialForm select[required]');
  let isValid = true;
  
  requiredFields.forEach(field => {
    if (!field.value || !field.value.trim()) {
      field.style.borderColor = '#e74c3c';
      isValid = false;
      
      setTimeout(() => {
        field.style.borderColor = '';
      }, 3000);
    }
  });
  
  if (!isValid) {
    showToast('Lütfen tüm zorunlu alanları doldurunuz.', 'error');
  }
  
  return isValid;
}

// Başlangıç formuna geri dön
function goBackToInitial() {
  if (formChanged) {
    if (!confirm('Formda yapılan değişiklikler kaybolacak. Devam etmek istediğinizden emin misiniz?')) {
      return;
    }
  }

  // Smooth transition
  const activeForm = document.querySelector('.form-section.active');
  const initialForm = document.getElementById('initial-form');
  
  if (activeForm && initialForm) {
    activeForm.style.opacity = '0';
    setTimeout(() => {
      activeForm.classList.remove('active');
      activeForm.style.display = 'none';
      
      initialForm.style.display = 'block';
      initialForm.style.opacity = '0';
      
      setTimeout(() => {
        initialForm.style.opacity = '1';
        updateProgress();
      }, 50);
    }, 300);
  }
  
  // Seçimi sıfırla
  selectedFormType = null;
  formChanged = false;
  
  showToast('Ana forma geri dönüldü.', 'success');
}

// Form kaydetme (PWA enhanced)
function kaydetForm(formType) {
  console.log('💾 Form kaydediliyor:', formType);
  
  const form = document.getElementById(`${formType}GorusmeForm`);
  
  // Validasyon
  if (!validateForm(formType)) {
    return;
  }
  
  // Loading state
  const button = event.target;
  const originalText = button.innerHTML;
  button.disabled = true;
  button.innerHTML = '⏳ Kaydediliyor...';
  
  // Simulate saving process
  setTimeout(async () => {
    try {
      // Tüm verileri birleştir
      const data = collectFormData(form, formType);
      
      console.log('📋 Form Verileri:', data);
      
      // PWA offline storage
      await saveFormOffline(data, formType);
      
      // JSON dosyası olarak indir
      downloadAsJSON(data, formType);
      
      // Başarı mesajı
      showToast(`${getFormDisplayName(formType)} formu başarıyla kaydedildi! 🎉`, 'success');
      
      // Show notification if permission granted
      showFormSavedNotification(formType);
      
      // Form'u sıfırla seçeneği sun
      setTimeout(() => {
        if (confirm('Form başarıyla kaydedildi. Yeni bir form doldurmak ister misiniz?')) {
          temizleForm();
        }
      }, 2000);
      
    } catch (error) {
      console.error('❌ Form kaydetme hatası:', error);
      showToast('Form kaydedilirken bir hata oluştu.', 'error');
    } finally {
      // Reset button
      button.disabled = false;
      button.innerHTML = originalText;
    }
  }, 1500);
}

// Form offline kaydetme
async function saveFormOffline(data, formType) {
  try {
    // LocalStorage'a kaydet
    const existingForms = JSON.parse(localStorage.getItem('all_forms') || '[]');
    existingForms.push(data);
    localStorage.setItem('all_forms', JSON.stringify(existingForms));
    
    // Service Worker'a bildir
    if (swRegistration && swRegistration.active) {
      swRegistration.active.postMessage({
        type: 'CACHE_FORM_DATA',
        payload: data
      });
    }
    
    console.log('💾 Form offline kaydedildi');
    
    // Background sync kaydet (çevrimiçi olduğunda senkronize edilecek)
    if (!isOnline) {
      await triggerBackgroundSync();
    }
    
  } catch (error) {
    console.error('❌ Offline kaydetme hatası:', error);
    throw error;
  }
}

// Form kaydedildi bildirimi
async function showFormSavedNotification(formType) {
  if ('Notification' in window && Notification.permission === 'granted') {
    try {
      const notification = new Notification('Form Kaydedildi', {
        body: `${getFormDisplayName(formType)} formu başarıyla kaydedildi.`,
        icon: '/icon-192.png',
        badge: '/badge-72.png',
        tag: 'form-saved',
        vibrate: [200, 100, 200],
        requireInteraction: false
      });
      
      // Auto close after 5 seconds
      setTimeout(() => notification.close(), 5000);
      
    } catch (error) {
      console.log('Bildirim gösterilemedi:', error);
    }
  } else if ('Notification' in window && Notification.permission === 'default') {
    // Request permission for future notifications
    await Notification.requestPermission();
  }
}

// Mobil optimizasyonlar
function setupMobileOptimizations() {
  console.log('📱 Mobil optimizasyonlar kuruluyor...');
  
  // iOS Safari zoom engelleme
  document.addEventListener('touchstart', function(e) {
    if (e.touches.length > 1) {
      e.preventDefault();
    }
  });

  // Double tap zoom engelleme
  let lastTouchEnd = 0;
  document.addEventListener('touchend', function(e) {
    const now = (new Date()).getTime();
    if (now - lastTouchEnd <= 300) {
      e.preventDefault();
    }
    lastTouchEnd = now;
  }, false);

  // Virtual keyboard handling
  setupVirtualKeyboardHandling();
  
  console.log('✅ Mobil optimizasyonlar kuruldu');
}

// Virtual keyboard yönetimi
function setupVirtualKeyboardHandling() {
  const viewport = document.querySelector('meta[name=viewport]');
  
  document.addEventListener('focusin', (e) => {
    if (e.target.matches('input, textarea, select')) {
      // iOS Safari için viewport ayarı
      if (viewport && /iPhone|iPad/.test(navigator.userAgent)) {
        viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, user-scalable=no');
      }
      
      // Elementi görünür alana kaydır
      setTimeout(() => {
        e.target.scrollIntoView({ 
          behavior: 'smooth', 
          block: 'center',
          inline: 'nearest'
        });
      }, 300);
    }
  });

  document.addEventListener('focusout', (e) => {
    if (viewport && /iPhone|iPad/.test(navigator.userAgent)) {
      viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, user-scalable=no');
    }
  });
}

// Keyboard navigation
function handleKeyboardNavigation(e) {
  if (e.key === 'Tab') {
    // Enhanced tab navigation
    const focusableElements = document.querySelectorAll(
      'input:not([disabled]), select:not([disabled]), textarea:not([disabled]), button:not([disabled]), [tabindex]:not([tabindex="-1"])'
    );
    
    const focusedIndex = Array.from(focusableElements).indexOf(document.activeElement);
    
    if (e.shiftKey && focusedIndex === 0) {
      e.preventDefault();
      focusableElements[focusableElements.length - 1].focus();
    } else if (!e.shiftKey && focusedIndex === focusableElements.length - 1) {
      e.preventDefault();
      focusableElements[0].focus();
    }
  }
  
  // Escape tuşu ile modalları kapat
  if (e.key === 'Escape') {
    closeAllModals();
  }
}

// Checkbox sınırlaması kurulumu
function setupCheckboxLimits() {
  console.log('☑️ Checkbox sınırlamaları kuruluyor...');
  const formTypes = ['muhtarlik', 'okul', 'asm', 'hastane', 'hem', 'genclik'];
  
  formTypes.forEach(formType => {
    setupCheckboxGroup(formType);
  });
  
  console.log('✅ Checkbox sınırlamaları kuruldu');
}

// Checkbox grup kurulumu
function setupCheckboxGroup(formType) {
  // Farklı form türleri için farklı grup isimleri
  const groupNames = {
    'muhtarlik': 'sosyalSorunlar',
    'okul': 'sosyalRiskler', 
    'asm': 'sosyalSorunlar',
    'hastane': 'sosyalSorunlar',
    'hem': 'sosyalRiskler',
    'genclik': 'sosyalRiskler'
  };
  
  const groupName = groupNames[formType];
  if (!groupName) return;
  
  // Farklı container isimleri
  const containerSelector = `#${formType}-sosyal-sorunlar-group, #${formType}-sosyal-riskler-group`;
  const container = document.querySelector(containerSelector);
  if (!container) return;
  
  const checkboxes = container.querySelectorAll('input[type="checkbox"]');
  const counter = document.getElementById(`${formType}-selection-counter`);
  const otherCheckbox = container.querySelector('input[value="Diğer"]');
  const otherInput = document.getElementById(`${formType}-other-input`);
  const otherTextarea = otherInput ? otherInput.querySelector('textarea') : null;
  const maxSelections = 3;
  
  // Alfabetik sıralama
  sortCheckboxes(container);
  
  // Sayaç güncelleme
  function updateCounter() {
    const selected = Array.from(checkboxes).filter(cb => cb.checked);
    if (counter) {
      const counterText = formType === 'okul' || formType === 'hem' || formType === 'genclik' 
        ? 'En fazla 3 risk seçebilirsiniz. Seçilen: '
        : 'En fazla 3 sorun seçebilirsiniz. Seçilen: ';
      
      counter.textContent = `${counterText}${selected.length}/3`;
      
      // Renk değişimi
      if (selected.length === 0) {
        counter.style.background = '#fff3cd';
        counter.style.color = '#856404';
      } else if (selected.length >= maxSelections) {
        counter.style.background = '#f8d7da';
        counter.style.color = '#721c24';
      } else {
        counter.style.background = '#d1ecf1';
        counter.style.color = '#0c5460';
      }
    }
  }
  
  // Checkbox durumlarını kontrol et
  function updateCheckboxStates() {
    const selected = Array.from(checkboxes).filter(cb => cb.checked);
    const unselected = Array.from(checkboxes).filter(cb => !cb.checked);
    
    if (selected.length >= maxSelections) {
      unselected.forEach(cb => {
        cb.closest('.checkbox-item').classList.add('disabled');
        cb.disabled = true;
      });
    } else {
      checkboxes.forEach(cb => {
        cb.closest('.checkbox-item').classList.remove('disabled');
        cb.disabled = false;
      });
    }
    
    updateCounter();
    updateProgress();
  }
  
  // "Diğer" seçeneği kontrolü
  function handleOtherOption() {
    if (otherCheckbox && otherInput) {
      if (otherCheckbox.checked) {
        otherInput.classList.add('show');
        if (otherTextarea) {
          otherTextarea.required = true;
          setTimeout(() => otherTextarea.focus(), 300);
        }
      } else {
        otherInput.classList.remove('show');
        if (otherTextarea) {
          otherTextarea.required = false;
          otherTextarea.value = '';
        }
      }
    }
  }
  
  // Event listeners
  checkboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      // Haptic feedback (mobil cihazlarda)
      if (navigator.vibrate) {
        navigator.vibrate(50);
      }
      
      updateCheckboxStates();
      if (this === otherCheckbox) {
        handleOtherOption();
      }
    });
  });
  
  // Başlangıç durumu
  updateCheckboxStates();
}

// Checkbox'ları alfabetik sırala
function sortCheckboxes(container) {
  const items = Array.from(container.children);
  
  // "Diğer" seçeneğini ayır
  const otherItem = items.find(item => 
    item.querySelector('input') && item.querySelector('input').value === 'Diğer'
  );
  const regularItems = items.filter(item => 
    !item.querySelector('input') || item.querySelector('input').value !== 'Diğer'
  );
  
  // Alfabetik sıralama
  regularItems.sort((a, b) => {
    const textA = a.querySelector('label') ? a.querySelector('label').textContent.trim() : '';
    const textB = b.querySelector('label') ? b.querySelector('label').textContent.trim() : '';
    return textA.localeCompare(textB, 'tr');
  });
  
  // Yeniden yerleştir
  container.innerHTML = '';
  regularItems.forEach(item => container.appendChild(item));
  if (otherItem) container.appendChild(otherItem);
}

// Koşullu alanları kur
function setupConditionalFields() {
  console.log('🔀 Koşullu alanlar kuruluyor...');
  
  const radioGroups = document.querySelectorAll('input[type="radio"]');
  
  radioGroups.forEach(radio => {
    radio.addEventListener('change', function() {
      handleConditionalField(this);
      updateProgress();
    });
    
    // Sayfa yüklendiğinde mevcut seçimleri kontrol et
    if (radio.checked) {
      handleConditionalField(radio);
    }
  });

  // Sayfa yüklendiğinde tüm koşullu alanları kontrol et
  document.querySelectorAll('.form-section').forEach(section => {
    const formType = section.id.replace('-form', '');
    if (formType) {
      const radios = section.querySelectorAll('input[type="radio"]:checked');
      radios.forEach(radio => {
        handleConditionalField(radio);
      });
    }
  });
  
  console.log('✅ Koşullu alanlar kuruldu');
}

// Koşullu alan yönetimi
function handleConditionalField(radio) {
  const fieldMappings = {
    'shBilgisi': {
      'muhtarlik': 'muhtarlik-sh-bilgi-detay',
      'okul': 'okul-sh-bilgi-detay', 
      'asm': 'asm-sh-bilgi-detay',
      'hastane': 'hastane-sh-bilgi-detay',
      'hem': 'hem-sh-bilgi-detay',
      'genclik': 'genclik-sh-bilgi-detay'
    },
    'shIletisim': {
      'muhtarlik': 'muhtarlik-sh-iletisim-detay',
      'okul': 'okul-sh-iletisim-detay',
      'asm': 'asm-sh-iletisim-detay',
      'hastane': 'hastane-sh-iletisim-detay',
      'hem': 'hem-sh-iletisim-detay',
      'genclik': 'genclik-sh-iletisim-detay'
    },
    'ortakCalisma': {
      'muhtarlik': 'muhtarlik-ortak-calisma-detay',
      'okul': 'okul-ortak-calisma-detay',
      'asm': 'asm-ortak-calisma-detay',
      'hastane': 'hastane-ortak-calisma-detay',
      'hem': 'hem-ortak-calisma-detay',
      'genclik': 'genclik-ortak-calisma-detay'
    },
    'sakinBasvuru': {
      'muhtarlik': 'muhtarlik-sakin-basvuru-detay'
    }
    // Diğer form türleri için eklenebilir
  };
  
  const formType = radio.closest('.form-section') ? 
    radio.closest('.form-section').id.replace('-form', '') : 
    'unknown';
  const fieldId = fieldMappings[radio.name]?.[formType];
  
  if (!fieldId) return;
  
  const field = document.getElementById(fieldId);
  if (!field) return;
  
  const textarea = field.querySelector('textarea');
  const input = field.querySelector('input');
  
  const showConditions = ['Evet', 'Var'];
  const shouldShow = showConditions.includes(radio.value);

  if (shouldShow) {
    field.classList.add('show');
    if (textarea) {
      textarea.required = true;
      setTimeout(() => textarea.focus(), 300);
    }
    if (input) {
      input.required = true;
    }
  } else {
    field.classList.remove('show');
    if (textarea) {
      textarea.required = false;
      textarea.value = '';
    }
    if (input) {
      input.required = false;
      input.value = '';
    }
  }
}

// Form validasyonu kur
function setupFormValidation() {
  console.log('✅ Form validasyonları kuruluyor...');
  
  // Telefon numarası validasyonu
  const phoneInputs = document.querySelectorAll('input[type="tel"]');
  phoneInputs.forEach(input => {
    input.addEventListener('input', validatePhoneNumber);
    input.addEventListener('blur', validatePhoneNumber);
  });
  
  // Email validasyonu
  const emailInputs = document.querySelectorAll('input[type="email"]');
  emailInputs.forEach(input => {
    input.addEventListener('blur', validateEmail);
  });
  
  console.log('✅ Form validasyonları kuruldu');
}

// Telefon numarası validasyonu
function validatePhoneNumber(e) {
  const input = e.target;
  const value = input.value.replace(/\D/g, ''); // Sadece rakamlar
  const pattern = /^5[0-9]{9}$/;
  
  // Otomatik format
  if (value.length <= 10) {
    input.value = value;
  }
  
  // Validasyon
  if (value && !pattern.test(value)) {
    input.style.borderColor = '#e74c3c';
    showTooltip(input, 'Telefon numarası 5 ile başlamalı ve 10 haneli olmalıdır');
  } else {
    input.style.borderColor = value ? '#28a745' : '#e1e8ed';
    hideTooltip(input);
  }
}

// Email validasyonu
function validateEmail(e) {
  const input = e.target;
  const value = input.value.trim();
  const pattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  
  if (value && !pattern.test(value)) {
    input.style.borderColor = '#e74c3c';
    showTooltip(input, 'Geçerli bir email adresi giriniz');
  } else {
    input.style.borderColor = value ? '#28a745' : '#e1e8ed';
    hideTooltip(input);
  }
}

// Tooltip göster
function showTooltip(element, message) {
  hideTooltip(element); // Mevcut tooltip'i kaldır
  
  const tooltip = document.createElement('div');
  tooltip.className = 'tooltip';
  tooltip.textContent = message;
  tooltip.style.cssText = `
    position: absolute;
    background: #333;
    color: white;
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 12px;
    z-index: 1000;
    pointer-events: none;
    white-space: nowrap;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  `;
  
  element.parentNode.style.position = 'relative';
  element.parentNode.appendChild(tooltip);
  
  // Pozisyon ayarla
  const rect = element.getBoundingClientRect();
  const parentRect = element.parentNode.getBoundingClientRect();
  tooltip.style.top = (rect.bottom - parentRect.top + 5) + 'px';
  tooltip.style.left = '0px';
  
  element._tooltip = tooltip;
}

// Tooltip gizle
function hideTooltip(element) {
  if (element._tooltip) {
    element._tooltip.remove();
    element._tooltip = null;
  }
}

// Form verilerini topla
function collectFormData(form, formType) {
  const data = {
    formTuru: formType,
    formAdi: getFormDisplayName(formType),
    tarih: new Date().toISOString(),
    formVersion: '2.0',
    cihazBilgisi: {
      userAgent: navigator.userAgent,
      platform: navigator.platform,
      screenSize: `${screen.width}x${screen.height}`,
      timestamp: Date.now(),
      isOnline: isOnline,
      isPWA: window.matchMedia('(display-mode: standalone)').matches
    },
    ortakBilgiler: initialFormData,
    ozgulVeriler: {}
  };

  if (form) {
    const formData = new FormData(form);
    
    // Normal form verileri
    for (let [key, value] of formData.entries()) {
      if (data.ozgulVeriler[key]) {
        if (Array.isArray(data.ozgulVeriler[key])) {
          data.ozgulVeriler[key].push(value);
        } else {
          data.ozgulVeriler[key] = [data.ozgulVeriler[key], value];
        }
      } else {
        data.ozgulVeriler[key] = value;
      }
    }

    // Checkbox verilerini topla
    const checkboxSelectors = [
      '.checkbox-group input[type="checkbox"]:checked',
      '#' + formType + '-sosyal-sorunlar-group input[type="checkbox"]:checked',
      '#' + formType + '-sosyal-riskler-group input[type="checkbox"]:checked'
    ];
    
    checkboxSelectors.forEach(selector => {
      const checkedBoxes = form.querySelectorAll(selector);
      if (checkedBoxes.length > 0) {
        const groupName = checkedBoxes[0].name;
        if (groupName && !data.ozgulVeriler[groupName]) {
          data.ozgulVeriler[groupName] = Array.from(checkedBoxes).map(cb => cb.value);
        }
      }
    });

    // Radio button verilerini kontrol et
    const radioGroups = form.querySelectorAll('input[type="radio"]:checked');
    radioGroups.forEach(radio => {
      if (!data.ozgulVeriler[radio.name]) {
        data.ozgulVeriler[radio.name] = radio.value;
      }
    });
  }

  return data;
}

// Form validasyonu
function validateForm(formType) {
  console.log('🔍 Form validasyonu yapılıyor:', formType);
  
  let isValid = true;
  const errors = [];
  
  // Checkbox validasyonu
  const checkboxSelectors = [
    `input[name="sosyalSorunlar"]:checked`,
    `input[name="sosyalRiskler"]:checked`
  ];
  
  let checkboxes = [];
  checkboxSelectors.forEach(selector => {
    const found = document.querySelectorAll(selector);
    if (found.length > 0) {
      checkboxes = found;
    }
  });
  
  if (checkboxes.length === 0 || checkboxes.length > 3) {
    const errorSelectors = [
      `${formType}-sosyal-sorunlar-error`,
      `${formType}-sosyal-riskler-error`
    ];
    
    let errorElement = null;
    errorSelectors.forEach(selector => {
      const found = document.getElementById(selector);
      if (found) {
        errorElement = found;
      }
    });
    
    if (errorElement) {
      errorElement.classList.add('show');
      const errorText = formType === 'okul' || formType === 'hem' || formType === 'genclik' 
        ? 'Lütfen en az 1, en fazla 3 risk seçiniz.'
        : 'Lütfen en az 1, en fazla 3 sorun seçiniz.';
      errors.push(errorText);
      isValid = false;
      
      errorElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }

  // Diğer validasyon kontrolleri...
  if (!isValid) {
    showToast(`Form eksik veya hatalı: ${errors.length} hata bulundu`, 'error');
  }

  return isValid;
}

// Form temizleme
function temizleForm() {
  if (!confirm('Formu temizlemek istediğinizden emin misiniz? Tüm veriler silinecektir.')) {
    return;
  }

  const activeForm = document.querySelector('.form-section.active form');
  if (activeForm) {
    // Form reset
    activeForm.reset();
    
    // Koşullu alanları gizle
    document.querySelectorAll('.conditional-field').forEach(field => {
      field.classList.remove('show');
      const textarea = field.querySelector('textarea');
      const input = field.querySelector('input');
      if (textarea) {
        textarea.required = false;
        textarea.value = '';
      }
      if (input) {
        input.required = false;
        input.value = '';
      }
    });

    // Progress'i güncelle
    updateProgress();
    
    // Form değişiklik flag'ini sıfırla
    formChanged = false;
    
    showToast('Form başarıyla temizlendi! 🧹', 'success');
  }
}

// JSON dosyası olarak indir
function downloadAsJSON(data, formType) {
  const fileName = `${formType}_gorusme_formu_${new Date().toISOString().split('T')[0]}_${Date.now()}.json`;
  const jsonString = JSON.stringify(data, null, 2);
  
  // BOM (Byte Order Mark) ekleyerek UTF-8 encoding sağla
  const blob = new Blob(['\ufeff' + jsonString], { 
    type: 'application/json;charset=utf-8' 
  });
  
  const url = URL.createObjectURL(blob);
  
  const a = document.createElement('a');
  a.href = url;
  a.download = fileName;
  a.style.display = 'none';
  
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  console.log(`📁 Form "${fileName}" olarak indirildi`);
}

// Toast bildirim göster (PWA enhanced)
function showToast(message, type = 'success') {
  // Mevcut toast'ı kaldır
  const existingToast = document.querySelector('.toast');
  if (existingToast) {
    existingToast.remove();
  }

  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `
    <div style="display: flex; align-items: center; gap: 8px;">
      <span>${type === 'success' ? '✅' : '❌'}</span>
      <span>${message}</span>
    </div>
  `;
  
  // Mobil ve desktop için farklı pozisyonlama
  toast.style.cssText = `
    position: fixed;
    top: ${window.innerWidth <= 767 ? '10px' : '20px'};
    right: ${window.innerWidth <= 767 ? '10px' : '20px'};
    left: ${window.innerWidth <= 767 ? '10px' : 'auto'};
    max-width: ${window.innerWidth <= 767 ? 'none' : '300px'};
    padding: 15px 20px;
    border-radius: 8px;
    color: white;
    font-weight: 500;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transform: translateY(-100%);
    transition: transform 0.3s ease;
    z-index: 1000;
    background: ${type === 'success' ? '#28a745' : '#dc3545'};
  `;
  
  document.body.appendChild(toast);

  // Haptic feedback
  if (navigator.vibrate) {
    navigator.vibrate(type === 'success' ? [100] : [100, 50, 100]);
  }

  // Show animation
  setTimeout(() => {
    toast.style.transform = 'translateY(0)';
  }, 100);

  // Auto hide
  setTimeout(() => {
    toast.style.transform = 'translateY(-100%)';
    setTimeout(() => {
      if (toast.parentNode) {
        toast.remove();
      }
    }, 300);
  }, type === 'error' ? 5000 : 3000);

  // Click to dismiss
  toast.addEventListener('click', () => {
    toast.style.transform = 'translateY(-100%)';
    setTimeout(() => {
      if (toast.parentNode) {
        toast.remove();
      }
    }, 300);
  });
}

// Default tarih ayarla
function setDefaultDate() {
  const today = new Date().toISOString().split('T')[0];
  const dateInput = document.getElementById('gorusme-tarihi');
  if (dateInput) {
    dateInput.value = today;
  }
}

// Modal'ları kapat
function closeAllModals() {
  document.querySelectorAll('.modal, .overlay').forEach(modal => {
    modal.style.display = 'none';
  });
}

// Auto-save (localStorage + PWA)
function autoSave() {
  if (selectedFormType) {
    try {
      const activeForm = document.querySelector('.form-section.active form');
      if (activeForm) {
        const data = collectFormData(activeForm, selectedFormType);
        localStorage.setItem(`autosave_${selectedFormType}`, JSON.stringify(data));
        
        // Service Worker'a bildir
        if (swRegistration && swRegistration.active) {
          swRegistration.active.postMessage({
            type: 'CACHE_FORM_DATA',
            payload: data
          });
        }
        
        console.log('📝 Otomatik kayıt yapıldı');
      }
    } catch (e) {
      console.log('Otomatik kayıt kullanılamıyor');
    }
  }
}

// Performance monitoring
function logPerformance() {
  if (performance && performance.mark) {
    performance.mark('form-interaction');
    console.log('📊 Performance logged');
  }
}

// Error reporting (PWA enhanced)
function reportError(error, context) {
  console.error('🚨 PWA Form Hatası:', {
    error: error.message,
    context: context,
    timestamp: new Date().toISOString(),
    userAgent: navigator.userAgent,
    url: window.location.href,
    isOnline: isOnline,
    isPWA: window.matchMedia('(display-mode: standalone)').matches,
    swState: swRegistration ? swRegistration.state : 'not registered'
  });
  
  // Service Worker'a hata bildir
  if (swRegistration && swRegistration.active) {
    swRegistration.active.postMessage({
      type: 'ERROR_REPORT',
      payload: {
        error: error.message,
        context: context,
        timestamp: Date.now()
      }
    });
  }
}

// Auto-save interval (her 30 saniyede bir)
setInterval(autoSave, 30000);

// Debug için global erişim
window.debugPWA = {
  locationData,
  fillIllers,
  updateIlceler,
  updateMahalleler,
  selectedFormType,
  initialFormData,
  formChanged,
  isOnline,
  swRegistration,
  deferredPrompt
};

console.log('🚀 PWA Form script başarıyla yüklendi!');
console.log('📱 Cihaz bilgisi:', {
  platform: navigator.platform,
  userAgent: navigator.userAgent,
  screenSize: `${screen.width}x${screen.height}`,
  touchSupport: 'ontouchstart' in window,
  isOnline: navigator.onLine,
  isPWA: window.matchMedia('(display-mode: standalone)').matches
});
console.log('🔧 Debug için window.debugPWA kullanabilirsiniz');

</script>
</body>
</html>